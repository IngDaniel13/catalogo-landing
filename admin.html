<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrador ‚Äî SHOPDE</title>
  <meta name="robots" content="noindex, nofollow" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>

<div class="admin-layout">

  <!-- ===== SIDEBAR ===== -->
  <aside class="admin-sidebar">
    <div class="sidebar-logo">
      <a href="index.html" class="logo" style="color:white">
        <span class="logo-dot"></span>
        SHOPDE
      </a>
    </div>
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" data-section="products">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        Productos
      </a>
      <a href="#" class="nav-item" data-section="categories">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        Categor√≠as
      </a>
      <a href="index.html" class="nav-item" target="_blank">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        Ver cat√°logo
      </a>
    </nav>
    <div class="sidebar-footer">
      <button id="logoutBtn" class="nav-item w-full" style="width:100%">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Cerrar sesi√≥n
      </button>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <div class="admin-main">

    <!-- Topbar -->
    <div class="admin-topbar">
      <span id="topbarTitle" class="topbar-title">Productos</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="adminUserEmail" class="text-sm text-gray"></span>
      </div>
    </div>

    <!-- Content -->
    <div class="admin-content">

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(37,211,102,.1)">üì¶</div>
          <div class="stat-info">
            <h3 id="statProducts">‚Äî</h3>
            <p>Productos</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(24,119,242,.1)">üóÇÔ∏è</div>
          <div class="stat-info">
            <h3 id="statCats">‚Äî</h3>
            <p>Categor√≠as</p>
          </div>
        </div>
      </div>

      <!-- ===== PRODUCTS SECTION ===== -->
      <div id="sectionProducts">
        <div class="admin-card">
          <div class="admin-card-header">
            <h2>Lista de Productos</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input type="search" id="adminSearch" class="filter-select" placeholder="Buscar..." style="width:180px;height:38px" />
              <button id="btnNewProduct" class="btn btn-primary">
                + Nuevo producto
              </button>
            </div>
          </div>
          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Categor√≠a</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="productsTableBody">
                <tr><td colspan="5" style="text-align:center;padding:40px;color:#9e9e9e">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ===== CATEGORIES SECTION ===== -->
      <div id="sectionCategories" class="hidden">
        <div class="admin-card">
          <div class="admin-card-header">
            <h2>Categor√≠as</h2>
            <button id="btnNewCat" class="btn btn-primary">+ Nueva categor√≠a</button>
          </div>
          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="catsTableBody">
                <tr><td colspan="2" style="text-align:center;padding:40px;color:#9e9e9e">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ===== MODAL: PRODUCTO ===== -->
<div id="productModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Nuevo producto</h2>
      <button class="modal-close" id="closeProductModal">‚úï</button>
    </div>

    <div id="modalError" class="error-message"></div>

    <input type="hidden" id="productId" />

    <div class="form-group">
      <label class="form-label">Nombre *</label>
      <input type="text" id="productName" class="form-control" placeholder="Ej: Zapatillas deportivas negras" />
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group">
        <label class="form-label">Precio *</label>
        <input type="number" id="productPrice" class="form-control" placeholder="0" min="0" step="0.01" />
      </div>
      <div class="form-group">
        <label class="form-label">Categor√≠a *</label>
        <select id="productCategory" class="form-control">
          <option value="">Seleccionar...</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Descripci√≥n</label>
      <textarea id="productDesc" class="form-control" placeholder="Descripci√≥n detallada del producto..."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Imagen del producto *</label>
      <div class="upload-area" id="uploadArea">
        <input type="file" id="imageFile" accept="image/*" />
        <div id="uploadPlaceholder">
          <div class="upload-icon">üì∏</div>
          <div class="upload-text">Arrastra una imagen o haz clic para seleccionar<br /><span style="font-size:0.75rem;color:#bbb">JPG, PNG, WEBP ‚Äî m√°x 10 MB</span></div>
        </div>
        <div class="upload-preview" id="uploadPreview">
          <img id="previewImg" src="" alt="Preview" />
          <button type="button" class="preview-remove" id="removePreview" title="Quitar imagen">‚úï</button>
        </div>
      </div>
      <div class="progress-bar-wrap" id="progressWrap">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <input type="hidden" id="productImageUrl" />
    </div>

    <!-- Preview de producto -->
    <div id="productPreview" class="hidden" style="background:var(--gray-50);border-radius:12px;padding:16px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <img id="previewThumb" src="" alt="" style="width:60px;height:60px;object-fit:cover;border-radius:8px;background:var(--gray-200)" />
      <div>
        <div id="previewName" style="font-weight:600;font-size:0.9rem"></div>
        <div id="previewPrice" style="color:var(--accent);font-weight:700;font-size:0.9rem"></div>
        <div id="previewCat" style="font-size:0.75rem;color:var(--gray-400)"></div>
      </div>
    </div>

    <button id="saveProductBtn" class="btn btn-primary btn-lg w-full" style="justify-content:center">
      Guardar producto
    </button>
  </div>
</div>

<!-- ===== MODAL: CATEGOR√çA ===== -->
<div id="catModal" class="modal-overlay">
  <div class="modal" style="max-width:400px">
    <div class="modal-header">
      <h2 class="modal-title">Nueva categor√≠a</h2>
      <button class="modal-close" id="closeCatModal">‚úï</button>
    </div>
    <div id="catError" class="error-message"></div>
    <div class="form-group">
      <label class="form-label">Nombre de la categor√≠a *</label>
      <input type="text" id="catName" class="form-control" placeholder="Ej: Ropa, Electr√≥nicos..." />
    </div>
    <button id="saveCatBtn" class="btn btn-primary btn-lg w-full" style="justify-content:center">
      Crear categor√≠a
    </button>
  </div>
</div>

<!-- Toast -->
<div id="toastContainer" class="toast-container"></div>

<!-- ===== CONFIRM DELETE MODAL ===== -->
<div id="confirmModal" class="modal-overlay">
  <div class="modal" style="max-width:380px;text-align:center">
    <div style="font-size:2.5rem;margin-bottom:12px">üóëÔ∏è</div>
    <h2 class="modal-title" style="margin-bottom:8px">Confirmar eliminaci√≥n</h2>
    <p id="confirmMessage" class="text-gray text-sm" style="margin-bottom:24px"></p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button id="confirmCancelBtn" class="btn btn-outline" style="min-width:100px">Cancelar</button>
      <button id="confirmDeleteBtn" class="btn btn-danger" style="min-width:100px">Eliminar</button>
    </div>
  </div>
</div>

<script type="module">
  import { supabaseClient } from './js/supabase.js';
  import {
    requireAuth, loadStats, getProducts, createProduct, updateProduct, deleteProduct,
    getCategories, createCategory, deleteCategory, uploadToCloudinary,
    validateProductForm, renderProductRow
  } from './js/admin.js';
  import { formatPrice } from './js/filters.js';

  let currentUser = null;
  let allProducts = [];
  let categories  = [];
  let editingId   = null;
  let pendingDeleteFn = null;

  // ‚îÄ‚îÄ Toast helper
  function toast(msg, type = '') {
    const c = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  // ‚îÄ‚îÄ Auth guard
  async function init() {
    currentUser = await requireAuth();
    if (!currentUser) return;
    document.getElementById('adminUserEmail').textContent = currentUser.user?.email || '';
    await Promise.all([loadProductsSection(), loadCategoriesSection(), refreshStats()]);
  }

  // ‚îÄ‚îÄ Stats
  async function refreshStats() {
    const stats = await loadStats();
    document.getElementById('statProducts').textContent = stats.totalProducts;
    document.getElementById('statCats').textContent = stats.totalCats;
  }

  // ‚îÄ‚îÄ NAVIGATION
  document.querySelectorAll('.nav-item[data-section]').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const section = item.dataset.section;
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('sectionProducts').classList.toggle('hidden', section !== 'products');
      document.getElementById('sectionCategories').classList.toggle('hidden', section !== 'categories');
      document.getElementById('topbarTitle').textContent = section === 'products' ? 'Productos' : 'Categor√≠as';
    });
  });

  // ‚îÄ‚îÄ PRODUCTS SECTION
  async function loadProductsSection() {
    allProducts = await getProducts();
    renderProductsTable(allProducts);
  }

  function renderProductsTable(products) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    if (!products.length) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:40px;color:#9e9e9e">No hay productos. ¬°Agrega el primero!</td></tr>`;
      return;
    }
    products.forEach(p => {
      tbody.appendChild(renderProductRow(p,
        (product) => openEditModal(product),
        (product) => confirmDelete(`¬øEliminar "${product.name}"? Esta acci√≥n no se puede deshacer.`, () => handleDeleteProduct(product.id))
      ));
    });
  }

  // B√∫squeda en tabla
  document.getElementById('adminSearch').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    renderProductsTable(allProducts.filter(p => p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q)));
  });

  // ‚îÄ‚îÄ PRODUCT MODAL
  function openNewModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Nuevo producto';
    document.getElementById('productId').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productCategory').value = '';
    document.getElementById('productDesc').value = '';
    document.getElementById('productImageUrl').value = '';
    resetUploadArea();
    updatePreview();
    document.getElementById('modalError').classList.remove('visible');
    document.getElementById('productModal').classList.add('open');
  }

  function openEditModal(product) {
    editingId = product.id;
    document.getElementById('modalTitle').textContent = 'Editar producto';
    document.getElementById('productId').value = product.id;
    document.getElementById('productName').value = product.name;
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productCategory').value = product.category;
    document.getElementById('productDesc').value = product.description || '';
    document.getElementById('productImageUrl').value = product.image_url;
    // Mostrar imagen actual
    document.getElementById('uploadPlaceholder').style.display = 'none';
    const preview = document.getElementById('uploadPreview');
    preview.style.display = 'block';
    document.getElementById('previewImg').src = product.image_url;
    updatePreview();
    document.getElementById('modalError').classList.remove('visible');
    document.getElementById('productModal').classList.add('open');
  }

  document.getElementById('closeProductModal').addEventListener('click', () => {
    document.getElementById('productModal').classList.remove('open');
  });

  document.getElementById('btnNewProduct').addEventListener('click', openNewModal);

  // Live preview
  ['productName','productPrice','productCategory'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
  });

  function updatePreview() {
    const name     = document.getElementById('productName').value;
    const price    = document.getElementById('productPrice').value;
    const cat      = document.getElementById('productCategory').value;
    const imageUrl = document.getElementById('productImageUrl').value;
    const preview  = document.getElementById('productPreview');

    if (!name && !price) { preview.classList.add('hidden'); return; }
    preview.classList.remove('hidden');
    document.getElementById('previewName').textContent  = name || '‚Äî';
    document.getElementById('previewPrice').textContent = price ? `$${formatPrice(parseFloat(price))}` : '';
    document.getElementById('previewCat').textContent   = cat || '';
    if (imageUrl) document.getElementById('previewThumb').src = imageUrl;
  }

  // ‚îÄ‚îÄ IMAGE UPLOAD
  const imageFileInput = document.getElementById('imageFile');

  imageFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) await handleFileUpload(file);
  });

  // Drag & drop
  const uploadArea = document.getElementById('uploadArea');
  uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
  uploadArea.addEventListener('drop', async (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) await handleFileUpload(file);
  });

  async function handleFileUpload(file) {
    if (file.size > 10 * 1024 * 1024) { toast('La imagen supera 10 MB', 'error'); return; }
    const progressWrap = document.getElementById('progressWrap');
    const progressBar  = document.getElementById('progressBar');
    progressWrap.style.display = 'block';
    progressBar.style.width = '0%';

    // Preview local inmediato
    const reader = new FileReader();
    reader.onload = (ev) => {
      document.getElementById('uploadPlaceholder').style.display = 'none';
      document.getElementById('uploadPreview').style.display = 'block';
      document.getElementById('previewImg').src = ev.target.result;
    };
    reader.readAsDataURL(file);

    try {
      const url = await uploadToCloudinary(file, (pct) => {
        progressBar.style.width = pct + '%';
      });
      document.getElementById('productImageUrl').value = url;
      updatePreview();
      toast('Imagen subida correctamente ‚úì', 'success');
    } catch (err) {
      toast('Error al subir imagen: ' + err.message, 'error');
    } finally {
      setTimeout(() => { progressWrap.style.display = 'none'; }, 600);
    }
  }

  document.getElementById('removePreview').addEventListener('click', () => {
    resetUploadArea();
    document.getElementById('productImageUrl').value = '';
    imageFileInput.value = '';
    updatePreview();
  });

  function resetUploadArea() {
    document.getElementById('uploadPlaceholder').style.display = '';
    document.getElementById('uploadPreview').style.display = 'none';
    document.getElementById('previewImg').src = '';
  }

  // ‚îÄ‚îÄ SAVE PRODUCT
  document.getElementById('saveProductBtn').addEventListener('click', async () => {
    const payload = {
      name:        document.getElementById('productName').value.trim(),
      price:       parseFloat(document.getElementById('productPrice').value),
      category:    document.getElementById('productCategory').value,
      description: document.getElementById('productDesc').value.trim() || null,
      image_url:   document.getElementById('productImageUrl').value.trim(),
    };

    const errors = validateProductForm(payload);
    if (errors.length) {
      const errEl = document.getElementById('modalError');
      errEl.textContent = errors[0];
      errEl.classList.add('visible');
      return;
    }

    const btn = document.getElementById('saveProductBtn');
    btn.textContent = 'Guardando...';
    btn.disabled = true;

    try {
      if (editingId) {
        await updateProduct(editingId, payload);
        toast('Producto actualizado ‚úì', 'success');
      } else {
        await createProduct(payload);
        toast('Producto creado ‚úì', 'success');
      }
      document.getElementById('productModal').classList.remove('open');
      await loadProductsSection();
      await refreshStats();
    } catch (err) {
      document.getElementById('modalError').textContent = err.message;
      document.getElementById('modalError').classList.add('visible');
    } finally {
      btn.textContent = 'Guardar producto';
      btn.disabled = false;
    }
  });

  // ‚îÄ‚îÄ DELETE PRODUCT
  async function handleDeleteProduct(id) {
    try {
      await deleteProduct(id);
      toast('Producto eliminado', 'success');
      await loadProductsSection();
      await refreshStats();
    } catch (err) {
      toast('Error al eliminar: ' + err.message, 'error');
    }
  }

  // ‚îÄ‚îÄ CATEGORIES SECTION
  async function loadCategoriesSection() {
    categories = await getCategories();
    renderCategoriesTable(categories);
    // Poblar select del formulario de productos
    const select = document.getElementById('productCategory');
    const current = select.value;
    select.innerHTML = '<option value="">Seleccionar...</option>';
    categories.forEach(c => {
      select.innerHTML += `<option value="${c.name}" ${c.name === current ? 'selected' : ''}>${c.name}</option>`;
    });
  }

  function renderCategoriesTable(cats) {
    const tbody = document.getElementById('catsTableBody');
    tbody.innerHTML = '';
    if (!cats.length) {
      tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;padding:40px;color:#9e9e9e">No hay categor√≠as.</td></tr>`;
      return;
    }
    cats.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge badge-blue">${c.name}</span></td>
        <td><button class="btn btn-danger" style="padding:6px 12px;font-size:0.78rem" data-id="${c.id}" data-name="${c.name}">üóëÔ∏è Eliminar</button></td>`;
      tr.querySelector('button').addEventListener('click', () => {
        confirmDelete(`¬øEliminar categor√≠a "${c.name}"?`, () => handleDeleteCategory(c.id));
      });
      tbody.appendChild(tr);
    });
  }

  document.getElementById('btnNewCat').addEventListener('click', () => {
    document.getElementById('catName').value = '';
    document.getElementById('catError').classList.remove('visible');
    document.getElementById('catModal').classList.add('open');
  });

  document.getElementById('closeCatModal').addEventListener('click', () => {
    document.getElementById('catModal').classList.remove('open');
  });

  document.getElementById('saveCatBtn').addEventListener('click', async () => {
    const name = document.getElementById('catName').value.trim();
    if (!name) {
      document.getElementById('catError').textContent = 'Escribe un nombre para la categor√≠a.';
      document.getElementById('catError').classList.add('visible');
      return;
    }
    const btn = document.getElementById('saveCatBtn');
    btn.textContent = 'Creando...';
    btn.disabled = true;
    try {
      await createCategory(name);
      toast('Categor√≠a creada ‚úì', 'success');
      document.getElementById('catModal').classList.remove('open');
      await loadCategoriesSection();
      await refreshStats();
    } catch (err) {
      document.getElementById('catError').textContent = err.message.includes('unique') ? 'Ya existe una categor√≠a con ese nombre.' : err.message;
      document.getElementById('catError').classList.add('visible');
    } finally {
      btn.textContent = 'Crear categor√≠a';
      btn.disabled = false;
    }
  });

  async function handleDeleteCategory(id) {
    try {
      await deleteCategory(id);
      toast('Categor√≠a eliminada', 'success');
      await loadCategoriesSection();
      await refreshStats();
    } catch (err) {
      toast('Error: ' + err.message, 'error');
    }
  }

  // ‚îÄ‚îÄ CONFIRM MODAL
  function confirmDelete(message, onConfirm) {
    pendingDeleteFn = onConfirm;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').classList.add('open');
  }

  document.getElementById('confirmCancelBtn').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.remove('open');
    pendingDeleteFn = null;
  });

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (pendingDeleteFn) {
      document.getElementById('confirmModal').classList.remove('open');
      await pendingDeleteFn();
      pendingDeleteFn = null;
    }
  });

  // Close modals on overlay click
  ['productModal','catModal','confirmModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', (e) => {
      if (e.target.id === id) document.getElementById(id).classList.remove('open');
    });
  });

  // ‚îÄ‚îÄ LOGOUT
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'login.html';
  });

  // ‚îÄ‚îÄ INIT
  init();
</script>
</body>
</html>
